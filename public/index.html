<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <title>Document</title>
  <style>
    .player {
      margin-top: 15px;
      width: 100%;
    }

    .hide {
      display: none;
    }

    .send {
      margin-top: 15px;
    }

    .container {
      max-width: 450px;
      width: 95%;
      margin: auto;
      box-shadow: 0px 5px 10px 2px rgba(34, 60, 80, 0.2);
      border-radius: 25px;
      padding: 30px;
    }

    .txtarea {
      font-size: 1.5rem;
    }
  </style>
</head>

<body>
  <div class="container form-group shadow-textarea">
    <h2 class="h1">Введите текст частушки!</h2>
    <textarea class="txtarea form-control" rows="8" name="msg" placeholder="Ваша частушка:"></textarea>
    <button type="button" class="btn btn-primary btn-lg btn-block send">Отправить</button>
    <audio class="player hide" controls></audio>
  </div>
</body>

<script>
  let listenButton = document.querySelector(".send");
  let textBlock = document.querySelector(".txtarea");
  let audioBlock = document.querySelector(".player");
  listenButton.addEventListener("click", () => {
    audioBlock.classList.add('hide');
    listenButton.classList.remove('btn-primary');
    listenButton.classList.add('btn-danger');
    listenButton.textContent = 'Загрузка';
    fetch("/api/speech", {
      method: "post",
      body: JSON.stringify({
        text: textBlock.value,
      }),
      headers: {
        Accept: "application/json",
        "Content-Type": "application/json",
      },
    })
      .then((response) => {
        if (response.ok) {
          return response.blob();
        }
        return Promise.reject(`Ошибка: ${response.status}`);
      })
      .then((result) => {
        audioBlock.classList.remove('hide');
        listenButton.classList.add('btn-primary');
        listenButton.classList.remove('btn-danger');
        listenButton.textContent = 'Отправить';
        audioBlock.src = URL.createObjectURL(result);
        audioBlock.play();
      })
      .catch((error) => {

        textBlock.value = 'Произошла ошибка запроса!'
        listenButton.classList.add('btn-primary');
        listenButton.classList.remove('btn-danger');
        listenButton.textContent = 'Отправить';
        console.log(error);
      });
  });
</script>

</html>